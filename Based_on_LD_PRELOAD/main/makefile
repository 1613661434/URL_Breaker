# URLæ‹¦æˆªè€…ç¼–è¯‘é…ç½®
CXX = g++
# ç¼–è¯‘é€‰é¡¹ï¼š
CXXFLAGS = -Wall -fPIC -std=c++17 -O2 -pthread -I./ol/include
# åŠ¨æ€åº“é“¾æ¥å‚æ•°ï¼š
LDFLAGS = -shared -fPIC -Wl,--whole-archive ./ol/lib/libol.a -Wl,--no-whole-archive -ldl -pthread

# ç›®æ ‡æ–‡ä»¶ï¼š
SO_FILE = url_breaker.so

# æµ‹è¯•æ–‡ä»¶è·¯å¾„
TEST_DIR = ../test

# ç¼–è¯‘è§„åˆ™
all: $(SO_FILE) $(TEST_DIR)/test_conn_norm $(TEST_DIR)/test_conn_brea $(TEST_DIR)/test_conn_brea_whi $(TEST_DIR)/test_tcp_server

# åŠ¨æ€åº“ç¼–è¯‘
$(SO_FILE): URL_Breaker.o
	$(CXX) $(LDFLAGS) -o $@ $^
	@echo "âœ… åŠ¨æ€åº“ç¼–è¯‘å®Œæˆï¼š$@"

URL_Breaker.o: URL_Breaker.cpp
	$(CXX) $(CXXFLAGS) -c -o $@ $<

# éç™½åå•è¿›ç¨‹è®¿é—®éé»‘åå•URLæµ‹è¯•ç¨‹åº
$(TEST_DIR)/test_conn_norm: $(TEST_DIR)/test_conn_norm.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… éç™½åå•è¿›ç¨‹è®¿é—®éé»‘åå•URLæµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆï¼š$@"

# éç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLæµ‹è¯•ç¨‹åº
$(TEST_DIR)/test_conn_brea: $(TEST_DIR)/test_conn_brea.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… éç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLæµ‹è¯•ç¨‹åºï¼š$@"

# ç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLæµ‹è¯•ç¨‹åº
$(TEST_DIR)/test_conn_brea_whi: $(TEST_DIR)/test_conn_brea_whi.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… ç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLæµ‹è¯•ç¨‹åºï¼š$@"

# TCPæµ‹è¯•æœåŠ¡å™¨ç¨‹åº
$(TEST_DIR)/test_tcp_server: $(TEST_DIR)/test_tcp_server.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… æµ‹è¯•æœåŠ¡å™¨ç¨‹åºç¼–è¯‘å®Œæˆï¼š$@"

# æµ‹è¯•ç›®æ ‡
test: all
	@echo "========================================"
	@echo "ğŸ” ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨æœ¬åœ°TCPæµ‹è¯•æœåŠ¡å™¨"
	# å¯åŠ¨æœåŠ¡å™¨å¹¶è®°å½•PID
	$(TEST_DIR)/test_tcp_server & sleep 2

	@echo "========================================"
	@echo "ğŸ” ç¬¬äºŒæ­¥ï¼šæµ‹è¯•éç™½åå•è¿›ç¨‹è®¿é—®éé»‘åå•URLï¼ˆtest_conn_normï¼‰"
	LD_PRELOAD=./$(SO_FILE) $(TEST_DIR)/test_conn_norm

	@echo "========================================"
	@echo "ğŸ” ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•éç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLï¼ˆtest_conn_breaï¼‰"
	LD_PRELOAD=./$(SO_FILE) $(TEST_DIR)/test_conn_brea

	@echo "========================================"
	@echo "ğŸ” ç¬¬å››æ­¥ï¼šæµ‹è¯•ç™½åå•è¿›ç¨‹è®¿é—®é»‘åå•URLï¼ˆtest_conn_brea_whiï¼‰"
	LD_PRELOAD=./$(SO_FILE) $(TEST_DIR)/test_conn_brea_whi

	@echo "========================================"
	@echo "ğŸ” ç¬¬äº”æ­¥ï¼šæŸ¥çœ‹æ‹¦æˆªæ—¥å¿—"
	@tail -20 url_breaker.log || echo "æ—¥å¿—æ–‡ä»¶æš‚æœªç”Ÿæˆ"

# æ¸…ç†è§„åˆ™
clean:
	rm -f *.o *.so $(TEST_DIR)/test_conn_norm $(TEST_DIR)/test_conn_brea $(TEST_DIR)/test_conn_brea_whi $(TEST_DIR)/test_tcp_server
	rm -f ./url_breaker.log
	@echo "âœ… æ¸…ç†å®Œæˆ"